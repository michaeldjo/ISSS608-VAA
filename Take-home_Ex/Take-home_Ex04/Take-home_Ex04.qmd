---
title: "Take-home Exercise 4"
subtitle: "Singapore bi-lateral trade performance in 2020 to 2022"
author: "Michael Djohan"
date: 19 February 2023
date-modified: "`r Sys.Date()`"
execute: 
  warning: false
format: html
editor: visual
toc-depth: 5
---

## **1. Overview**

This exercise aims to uncover the impact of COVID-19, global economic and political dynamic in 2022 on Singapore bi-lateral trade using time-series visualisation. The visualization is designed using `ggplot2`, its extensions, and `tidyverse` packages.

The original Merchandise Trade dataset was downloaded from [Department of Statistics](https://www.singstat.gov.sg/find-data/search-by-theme/trade-and-investment/merchandise-trade/latest-data) titled *Merchandise Trade by Region/Market*

The file downloaded was *outputFile.xlsx*

The study period is from for **January 2020 to December 2022** period.

## **2. Data Preparation**

### 2.1 Install R packages and import dataset

The code chunk below uses `pacman::p_load()` to check if packages are installed. If they are, they will be launched into R. The packages installed are

-   `readxl`: Used to reaad data from excel files

-   `knitr`: Used for dynamic report generation

-   `lubridate`: Used to work with date and time

-   `tidyverse`: A collection of core packages designed for data science, used extensively for data preparation and wrangling.

    All packages can be found within CRAN.

```{r}
#Load packages
pacman::p_load(readxl, knitr, lubridate, tidyverse)
```

Import data from csv using `readxl::read_excel()` and store it in variable ***sgimport** and **sgexport***.

Note that by choosing the specific range, the period of interest (January 2020 to December 2022) is intentionally selected.

```{r}
#Import data
sgimport <- read_excel("data/outputFile.xlsx", sheet = "T1", range = "A10:AK129" )

sgexport <- read_excel("data/outputFile.xlsx", sheet = "T2", range = "A10:AK101" )
```

###### 

### 2.2 Data cleaning

#### 2.2.1 Cleaning the countries data for sgimport and sgexport

```{r}
sgimport_ctry <- sgimport |> 
  
  #remove the first 7 rows, which are Total and non-countries
  filter(!row_number() %in% c(1:7)) |> 
  
  #remove the '(Thousand Dollars)' string from column Data Series and call it Countries
  mutate(Countries = str_remove(`Data Series`, 
                                " \\(Thousand Dollars\\)"), 
         .after = `Data Series`) |> 
  
  #remove 'Data Series' column
  select(-`Data Series`) 

kable(head(sgimport_ctry))
```

```{r}
sgexport_ctry <- sgexport |> 
  
  #remove the first 7 rows, which are Total and non-countries
  filter(!row_number() %in% c(1:7)) |> 
  
  #remove the '(Thousand Dollars)' string from column Data Series and call it Countries
  mutate(Countries = str_remove(`Data Series`, 
                                " \\(Thousand Dollars\\)"), 
         .after = `Data Series`) |> 
  
  #remove 'Data Series' column
  select(-`Data Series`) 

kable(head(sgexport_ctry))
```

Identify differences between sgimport and sgexport as the number of rows are not the same

112-84 = 28. The difference below is 28, indicating Singapore import from these countries but there is no export data to these countries

```{r}
import_vs_export <- setdiff(sgimport_ctry$Countries, sgexport_ctry$Countries) |> 
  enframe(name = NULL, value = "diff") |> 
  arrange(diff)

import_vs_export  |> 
  kable(caption = "Countries in sgimport that is not in sgexport",
               row.names = TRUE)
```

#### 2.2.2 Pivot and transform datasets to time-series

```{r}
sgimport_cln <- sgimport_ctry |> 
  
  #pivot_longer to get year and month timeseries
  pivot_longer(cols = !Countries,
               names_to = c("Year", "Month"),
               names_sep = " ",
               values_to = "Import_SGD"
               ) |> 
  
  #Convert Month to factors and Years to integers for ordering purposes
  #Multiply values by 1000
  mutate(Month = factor(Month, levels = month.abb),
         Year = as.integer(Year),
         Month_Year = make_date(Year, Month),
         .before = 1) |> 
  
  mutate(Import_SGD = Import_SGD*1000) 

sgimport_cln
```

```{r}
sgexport_cln <- sgexport_ctry |> 
  
  #pivot_longer to get year and month timeseries
  pivot_longer(cols = !Countries,
               names_to = c("Year", "Month"),
               names_sep = " ",
               values_to = "Export_SGD"
               ) |> 
  
  #Convert Month and Year to factors for ordering purposes
  #Multiply values by 1000
  mutate(Month = factor(Month, levels = month.abb),
         Year = as.integer(Year),
         Month_Year = make_date(Year, Month),
         .before = 1) |> 
  
  mutate(Export_SGD = Export_SGD*1000) 

sgexport_cln
```

#### 2.2.3 Joining the two datasets and calculate trade balance

Explain left join

Add trade balance and trade values

Additionally also exclude countries with which Singapore has no available export data. We cannot assume that the exports are zero, just because there is no available data. This is to avoid incomplete data when analysing trade balances.

"Germany, Democratic Republic Of" is the official name of East Germany, a state that no longer exists since German reunification in 1990. As such, the import and export values are zeroes. This country is in dataset as the dataset tracks Singapore import/export data from 1976. Given the scope of the study from January 2020 onwards, we will remove this country as well.

```{r}
sgtrade_cln <- sgimport_cln |> 
  
  #join sgimport_cln with sgexport_cln
  left_join(sgexport_cln, by = c('Countries' = 'Countries', 'Month_Year' = 'Month_Year', 'Month' = 'Month', 'Year' = 'Year')) |> 
  
  #Calculated trade balance
  mutate(Trade_Balance_SGD = Export_SGD - Import_SGD,
         Trade_Volumes_SGD = Export_SGD + Import_SGD) |> 
  
  #remove countries with non-available export data
  filter(!Countries %in% c(import_vs_export$diff, "Germany, Democratic Republic Of"))

kable(head(sgtrade_cln))
```

#### 2.2.4 Finding top countries by trade volume

```{r}
sgtrade_top_ctry <- sgtrade_cln |> 
  group_by(Countries) |> 
  summarise(Total_Trade_Volumes_SGD = sum(Trade_Volumes_SGD)) |> 
  ungroup() |> 
  arrange(desc(Total_Trade_Volumes_SGD))

kable(head(sgtrade_top_ctry))
```

#### 2.2.5 Finding top countries by rate of change of trade volume from 2020 to 2022

```{r}
sgtrade_top_rate_ctry <- sgtrade_cln |> 
  group_by(Countries, Year) |>
  summarise(Total_Trade_Volumes_SGD = sum(Trade_Volumes_SGD)) |> 
  ungroup() |> 
  filter(Year %in% c(2020,2022)) |> 
  pivot_wider(names_from = Year,
              values_from = Total_Trade_Volumes_SGD) 
  #mutate(Diff_Trade_Volumes_SGD_2020_2022 = abs(sgtrade_cln$2022 - #sgtrade_cln$2020))
  
```

####  
